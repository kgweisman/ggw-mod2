---
title: 'GGW-mod2: Factor Analysis'
output:
  html_document:
    theme: flatly
    toc: yes
  pdf_document:
    toc: yes
---

# Setup

```{r workspace setup, echo = F}
# load libraries
library(devtools)
library(psych)
library(stats)
library(lavaan)
library(nFactors)
library(langcog)
library(directlabels)
library(ggplot2)
library(knitr)
library(tidyr)
library(dplyr)

# clear workspace
rm(list = ls(all = T))
graphics.off()
```

```{r functions, echo = F}
# make cleanup function
cleanup <- function(datasource) {
  if(datasource %in% c("study 1", "study 2")) {
    
    # set target dataset
    if(datasource == "study 1"){d <- d_raw_study1}
    if(datasource == "study 2"){d <- d_raw_study2}
    
    # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH == 1, # exclude Ps who fail catch trials 
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2015 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode background and demographic variables
    d_clean <- d_clean_1 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             religion_buddhism:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3) %>%
      mutate( # deal with religion
        religion_buddhism = 
          factor(ifelse(is.na(religion_buddhism), "", "buddhism ")),
        religion_christianity = 
          factor(ifelse(is.na(religion_christianity), "", "christianity ")),
        religion_hinduism = 
          factor(ifelse(is.na(religion_hinduism), "", "hinduism ")),
        religion_islam = 
          factor(ifelse(is.na(religion_islam), "", "islam ")),
        religion_jainism = 
          factor(ifelse(is.na(religion_jainism), "", "jainism ")),
        religion_judaism = 
          factor(ifelse(is.na(religion_judaism), "", "judaism ")),
        religion_sikhism = 
          factor(ifelse(is.na(religion_sikhism), "", "sikhism ")),
        religion_other = 
          factor(ifelse(is.na(religion_other), "", "other ")),
        religion_none = 
          factor(ifelse(is.na(religion_none), "", "none ")),
        religion_prefno = 
          factor(ifelse(is.na(religion_prefno), "", "other_prefno ")),
        religion_cat = paste0(religion_buddhism, religion_christianity, 
                              religion_hinduism, religion_islam, 
                              religion_jainism, religion_judaism, 
                              religion_sikhism, religion_other, 
                              religion_none, religion_prefno),
        religion_cat2 = factor(sub(" +$", "", religion_cat)),
        religion_cat3 = factor(ifelse(grepl(" ", religion_cat2) == T, 
                                      "multireligious",
                                      as.character(religion_cat2)))) %>%
      select(study:gender, feedback:race_cat, religion_cat3) %>%
      rename(religion_cat = religion_cat3)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1)
  }
  
  if(datasource == "study 3") {
    
    # set target dataset
    d <- d_raw_study3
    
    # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH..characterL) | 
                                     is.na(CATCH..characterR), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH..characterL == 5, # exclude Ps who fail catch trials 
             CATCH..characterR == 5,
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2015 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode background and demographic variables
    d_clean_2 <- d_clean_1 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             religion_buddhism:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3) %>%
      mutate( # deal with religion
        religion_buddhism = 
          factor(ifelse(is.na(religion_buddhism), "", "buddhism ")),
        religion_christianity = 
          factor(ifelse(is.na(religion_christianity), "", "christianity ")),
        religion_hinduism = 
          factor(ifelse(is.na(religion_hinduism), "", "hinduism ")),
        religion_islam = 
          factor(ifelse(is.na(religion_islam), "", "islam ")),
        religion_jainism = 
          factor(ifelse(is.na(religion_jainism), "", "jainism ")),
        religion_judaism = 
          factor(ifelse(is.na(religion_judaism), "", "judaism ")),
        religion_sikhism = 
          factor(ifelse(is.na(religion_sikhism), "", "sikhism ")),
        religion_other = 
          factor(ifelse(is.na(religion_other), "", "other ")),
        religion_none = 
          factor(ifelse(is.na(religion_none), "", "none ")),
        religion_prefno = 
          factor(ifelse(is.na(religion_prefno), "", "other_prefno ")),
        religion_cat = paste0(religion_buddhism, religion_christianity, 
                              religion_hinduism, religion_islam, 
                              religion_jainism, religion_judaism, 
                              religion_sikhism, religion_other, 
                              religion_none, religion_prefno),
        religion_cat2 = factor(sub(" +$", "", religion_cat)),
        religion_cat3 = factor(ifelse(grepl(" ", religion_cat2) == T, 
                                      "multireligious",
                                      as.character(religion_cat2)))) %>%
      select(study:gender, feedback:race_cat, religion_cat3) %>%
      rename(religion_cat = religion_cat3)
    
    # rename response variables
    d_clean_3 <- d_clean_2
    names(d_clean_3) <- gsub("get", "", names(d_clean_3))
    names(d_clean_3) <- gsub("\\.", "", names(d_clean_3))
    names(d_clean_3) <- gsub("char", "_char", names(d_clean_3))
    names(d_clean_3)[names(d_clean_3) %in% c("_characterL", "_characterR")] <- 
      c("characterL", "characterR")
    
    # recode response variables (center)
    d_clean_4 <- d_clean_3
    for(i in 11:92) {
      d_clean_4[,i] <- d_clean_4[,i] - 4 # transform from 1 to 7 --> -3 to 3
    }
    
    # recode characterL vs. characterR as beetle vs. robot
    d_clean_5_demo <- d_clean_4 %>%
      select(study:condition, yob:religion_cat)
    
    d_clean_5_characterL <- d_clean_4 %>%
      mutate(target = characterL) %>%
      select(study, subid, target, happy_characterL:CATCH_characterL)
    names(d_clean_5_characterL) <- gsub("_characterL", "", 
                                        names(d_clean_5_characterL))
    
    d_clean_5_characterR <- d_clean_4 %>%
      mutate(target = characterR) %>%
      select(study, subid, target, happy_characterR:CATCH_characterR)
    names(d_clean_5_characterR) <- gsub("_characterR", "", 
                                        names(d_clean_5_characterR))
    
    d_clean <- d_clean_5_characterL %>%
      full_join(d_clean_5_characterR) %>%
      full_join(d_clean_5_demo) %>%
      select(study, subid, date:religion_cat, target:CATCH)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1, d_clean_2, d_clean_3, d_clean_4, d_clean_5_characterL, 
       d_clean_5_characterR, d_clean_5_demo, i)
  }
  
  if(datasource == "study 4") {
    
    # set target dataset
    d <- d_raw_study4

        # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH == 1, # exclude Ps who fail catch trials 
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2015 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode one character
    d_clean_2 <- d_clean_1 %>%
      mutate(condition = factor(ifelse(
        grepl("vegetative", as.character(condition)), "pvs",
        ifelse(grepl("blue", as.character(condition)), "bluejay",
               as.character(condition)))))
    
    # recode background and demographic variables
    d_clean <- d_clean_2 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             education:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1, d_clean_2)
  }
  
  # return cleaned dataset
  return(d_clean)
}

# make function for stripping dataframes for dimension reducation
makeDRDF <- function(datasource, chosenCondition) {
  
  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # rename variables for ease of function applpication
    d <- d3 %>%
      rename(order = condition,
             condition = target)
    
    # rename subids by condition if collapses across conditions
    d <- d %>%
      mutate(subid = paste(condition, subid, sep = "_"))
  }
  if(datasource == "study 4"){d <- d4}
  
  # filter by condition if specified
  if(chosenCondition %in% c("beetle", "robot")) {
    d <- d %>% filter(condition == chosenCondition)
  }
  
  # make stripped dataframe for dimension reducation analyses
  d_strip <- d %>%
    select(subid, happy:pride)
  d_strip <- data.frame(d_strip[,-1], row.names = d_strip[,1])
  
  # return stripped dataframe
  return(d_strip)
}

# make demographics functions
demoSampleSize <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # rename variables for ease of function applpication
    d <- d3 %>%
      rename(order = condition,
             condition = target)
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  sample_size <- vector()
  for(i in levels(d$condition)) {
    sample_size[as.character(i)] <- 
      as.numeric(d %>% filter(condition == i) %>% select(subid) %>% 
                   unique() %>% count())
  }

  # add total sample size  
  sample_size["all"] <- as.numeric(d %>% select(subid) %>% 
                                     unique() %>% count())
  
  # make into dataframe for using kable
  sample_size <- data.frame(sample_size) %>%
    add_rownames() %>%
    rename(condition = rowname,
           n = sample_size)
  
  # return dataframe for using kable
  return(sample_size)
}
demoDuration <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # recode variables for ease of function applpication
    d <- d3 %>%
      mutate(condition = "within-subjects")
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  duration <- d %>%
    group_by(condition) %>%
    summarise(min_duration = min(duration),
              max_duration = max(duration),
              median_duration = median(duration),
              mean_duration = mean(duration),
              sd_duration = sd(duration))

  # add total duration
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    all <- d %>%
      summarise(min_duration = min(duration),
                max_duration = max(duration),
                median_duration = median(duration),
                mean_duration = mean(duration),
                sd_duration = sd(duration)) %>%
      mutate(condition = "all")
    duration <- rbind(duration, all) # not sure why full_join doesn't work    
  }

  # return dataframe for using kable
  return(duration)
}
demoAge <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # recode variables for ease of function applpication
    d <- d3 %>%
      mutate(condition = "within-subjects")
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  age <- d %>%
    group_by(condition) %>%
    summarise(min_age = min(age_approx),
              max_age = max(age_approx),
              median_age = median(age_approx),
              mean_age = mean(age_approx),
              sd_age = sd(age_approx))

  # add total age
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    all <- d %>%
      summarise(min_age = min(age_approx),
                max_age = max(age_approx),
                median_age = median(age_approx),
                mean_age = mean(age_approx),
                sd_age = sd(age_approx)) %>%
      mutate(condition = "all")
    age <- full_join(age, all)
  }

  # return dataframe for using kable
  return(age)
}
demoGender <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}
  if(datasource == "study 4"){d <- d4}

  # get gender per condition and overall
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    gender <- data.frame(addmargins(with(d, table(condition, gender)))) %>%
      filter(gender != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    gender <- data.frame(with(d, table(gender))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, gender, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    gender <- gender %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, gender) %>%
    spread(gender, n)
  }
  
  if(datasource == "study 4") {
    gender <- gender %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c(levels(d$condition), "all"))) %>%
    arrange(condition, gender) %>%
    spread(gender, n)
  }
  
  # return dataframe for using kable
  return(gender)
}
demoRace <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}
  if(datasource == "study 4"){d <- d4}

  # get race per condition and overall
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    race <- data.frame(addmargins(with(d, table(condition, race_cat)))) %>%
      filter(race_cat != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    race <- data.frame(with(d, table(race_cat))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, race_cat, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    race <- race %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, race_cat) %>%
    spread(race_cat, n)
  }
  
  if(datasource == "study 4") {
    race <- race %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c(levels(d$condition), "all"))) %>%
    arrange(condition, race_cat) %>%
    spread(race_cat, n)
  }
  
  # return dataframe for using kable
  return(race)
}
demoReligion <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}

  # get religion per condition and overall
  if(datasource %in% c("study 1", "study 2")) {
    religion <- data.frame(addmargins(with(d, table(condition, religion_cat)))) %>%
      filter(religion_cat != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    religion <- data.frame(with(d, table(religion_cat))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, religion_cat, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    religion <- religion %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, religion_cat) %>%
    spread(religion_cat, n)
  }
  
  # return dataframe for using kable
  if(datasource == "study 4"){
    stop("Religion information not available for Study 4")
  } else {return(religion)}
}
demoEducation <- function(datasource) {

  # set target dataset
  if(datasource == "study 4"){d <- d4}
  
  # get education per condition and overall
  if(datasource == "study 4") {
    education <- 
      data.frame(addmargins(with(d, table(condition, education)))) %>%
      filter(education != "Sum") %>%
      rename(n = Freq) %>%
      mutate(condition = factor(ifelse(condition == "Sum",
                                       "all", as.character(condition)),
                                levels = c(levels(d$condition), "all")),
             education = factor(education,
                                levels = c(1:7, 0),
                                labels = c("some_HS",
                                           "HS_diploma",
                                           "some_college",
                                           "associates",
                                           "bachelors",
                                           "some_grad",
                                           "grad",
                                           "pref_no"))) %>%
      arrange(condition, education) %>%
      spread(education, n)
  }
  
  # return dataframe for using kable
  if(datasource %in% c("study 1", "study 2", "study 3")){
    stop("Education information not available for Studies 1-3")
  } else {return(education)}
}

# make scree plot to determine how many factors to extract
howManyFactors <- function (df) {
  # count eigenvalues > 1.0 (using correlation matrix)
  countEigen <- function(df) {
    eigenVals <- eigen(cor(df))$values
    nGreaterThan1 <- length(eigenVals[eigenVals > 1.00])
    nGreaterThan5Per <- length(eigenVals[eigenVals/40 > 0.05])
    results <- c("cutoff" = nGreaterThan1, "propVar" = nGreaterThan5Per)
    return(results)
  }

  # scree plot: look for elbow
  scree_df <- scree(df, main = "Scree plot")
  
  # eigenvalues: count how many > 1
  text(x = 20, y = 12, 
       labels = paste(countEigen(df)["cutoff"], 
                      "eigenvalues > 1.00 (for EFA)"))

  # eigenvalues: count how account for > 5% variance
  text(x = 20, y = 10, 
       labels = paste(countEigen(df)["propVar"], 
                      "eigenvalues > 5% variance (for EFA)"))
  
  # very simple structure: look at different indices
  # vss_unrotated_df <- VSS(df, n = 15, 
  #                                rotate = "none", plot = FALSE)
  # vss_rotated_df <- VSS(df, n = 15, 
  #                              rotate = "varimax", plot = FALSE)
}

# get factor loadings for some efa
getFactorLoadings <- function(efa) {
  factorLoadingsList <- list()
  for(i in 1:efa$factors) {
    factorNum <- paste0("F", i)
    df <- data.frame(X = sort(loadings(efa)[,i], decreasing = T))
    names(df) <- factorNum
    factorLoadingsList[[i]] <- df
  }
  return(factorLoadingsList)
}

# extract factor structure
# NOTE only works for 3 factor solutions!!
extractFStructure <- function(efa) {
  # examine factor loadings from s1 to structure latent variables for s2
  d_structure <- data.frame(loadings(efa)[]) %>%
    add_rownames(var = "mc") %>%
    mutate(
      bestFactor =
        ifelse(abs(Factor1) == abs(Factor2) & abs(Factor1) == abs(Factor3),
               "all tied",
               ifelse(abs(Factor1) == abs(Factor2),
                      "Factor1 and Factor2 tied",
                      ifelse(abs(Factor1) == abs(Factor3),
                             "Factor1 and Factor3 tied",
                             ifelse(abs(Factor2) == abs(Factor3),
                                    "Factor2 and Factor3 tied",
                                    ifelse(abs(Factor1) > abs(Factor2),
                                           ifelse(abs(Factor1) > abs(Factor3),
                                                  "Factor1",
                                                  "Factor3"),
                                           ifelse(abs(Factor2) > abs(Factor3),
                                                  "Factor2",
                                                  "Factor3"))))))) %>%
    mutate(bestFactor = factor(bestFactor))
  
  d_structure_Factor1 <- d_structure %>%
    filter(bestFactor == "Factor1") %>%
    arrange(desc(Factor1)) %>%
    select(mc, Factor1) %>%
    rename(mc_Factor1 = mc,
           loading_Factor1 = Factor1) %>%
    add_rownames(var = "order")
  
  d_structure_Factor2 <- d_structure %>%
    filter(bestFactor == "Factor2") %>%
    arrange(desc(Factor2)) %>%
    select(mc, Factor2) %>%
    rename(mc_Factor2 = mc,
           loading_Factor2 = Factor2) %>%
    add_rownames(var = "order")
  
  d_structure_Factor3 <- d_structure %>%
    filter(bestFactor == "Factor3") %>%
    arrange(desc(Factor3)) %>%
    select(mc, Factor3) %>%
    rename(mc_Factor3 = mc,
           loading_Factor3 = Factor3) %>%
    add_rownames(var = "order")
  
  d_structure_allFactors <- d_structure_Factor1 %>%
    full_join(d_structure_Factor2) %>%
    full_join(d_structure_Factor3)
  
  # return table of factor structure
  return(d_structure_allFactors)
}
```

# Data preparation

```{r data upload, echo = F}
# study 1 (2015-12-15, 2 conditions, between-subjects)
d_raw_study1 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v1 (2 conditions between)/GGWmod2_v1_clean.csv") %>%
  mutate(study = "study 1")

# study 2 (2016-01-12, 2 conditions, between-subjects - REPLICATION)
d_raw_study2 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v1 (replication)/GGWmod2_v1_replication_clean.csv") %>%
  mutate(study = "study 2")

# study 3 (2016-01-10, 2 conditions, within-subjects)
d_raw_study3 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v2 (2 conditions within)/GGWmod2_v2_withinsubjects_clean.csv") %>%
  mutate(study = "study 3")

# study 4 (2016-01-14, 21 conditions, between-subjects)
d_raw_study4 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v3 (21 conditions between)/GGWmod2_v3_many_characters_clean.csv") %>%
  mutate(study = "study 4")
```

```{r data cleanup, echo = F}
# clean up datasets
d1 <- cleanup("study 1")
d2 <- cleanup("study 2")
d3 <- cleanup("study 3")
d4 <- cleanup("study 4")
```

```{r dataframes for dimension reducation, echo = F}
# make dataframes for s1
d1_beetle <- makeDRDF("study 1", "beetle")
d1_robot <- makeDRDF("study 1", "robot")
d1_all <- makeDRDF("study 1", "all")

# make dataframes for study 2
d2_beetle <- makeDRDF("study 2", "beetle")
d2_robot <- makeDRDF("study 2", "robot")
d2_all <- makeDRDF("study 2", "all")

# make dataframes for study 3
d3_beetle <- makeDRDF("study 3", "beetle")
d3_robot <- makeDRDF("study 3", "robot")
d3_all <- makeDRDF("study 3", "all")

# make dataframes for study 4
d4_all <- makeDRDF("study 4", "all")
```

# Study 1 (2015-12-15, 2 conditions, between-subjects)

## Demographics

```{r s1 demographics, echo = F}
# make demographics tables
kable(demoSampleSize("study 1"), align = "l", digits = 2,
      caption = "Study 1: Sample size")
kable(demoDuration("study 1"), align = "l", digits = 2,
      caption = "Study 1: Study duration (minutes)")
kable(demoAge("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant age (years; approximate)")
kable(demoGender("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant gender")
kable(demoRace("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant race/ethnicity")
kable(demoReligion("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant religion")
```

## Analyses

### Exploratory factor analysis: BEETLE condition

#### Step 1: Determine how many factors to extract

```{r s1 beetle how many factors, echo = F}
howManyFactors(d1_beetle)
```

```{r s1 beetle set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_beetle <- 2
```

#### Step 2: Run EFA without rotation

```{r s1 beetle no rotation, echo = F}
# run EFA without rotation with N factors
efa_d1_beetle_unrotatedN <- factanal(d1_beetle, nfactors_d1_beetle, r = "none")
print(efa_d1_beetle_unrotatedN)

# get loadings for each factor
efa_d1_beetle_unrotatedN_loadings <- getFactorLoadings(efa_d1_beetle_unrotatedN)
```

#### Step 3: Run EFA with varimax rotation

```{r s1 beetle varimax rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_beetle_rotatedN <- factanal(d1_beetle, nfactors_d1_beetle, r = "none")
print(efa_d1_beetle_rotatedN)

# get loadings for each factor
efa_d1_beetle_rotatedN_loadings <- getFactorLoadings(efa_d1_beetle_rotatedN)
```

##### Factor 1

```{r s1 beetle varimax rotation F1, echo = F}
# examine factor 1
kable(efa_d1_beetle_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 1")
```

##### Factor 2

```{r s1 beetle varimax rotation F2, echo = F}
# examine factor 2
kable(efa_d1_beetle_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s1 beetle varimax rotation F3, echo = F}
# # examine factor 3
# kable(efa_d1_beetle_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 3")
```

### Exploratory factor analysis: ROBOT condition

#### Step 1: Determine how many factors to extract

```{r s1 robot how many factors, echo = F}
howManyFactors(d1_robot)
```

```{r s1 robot set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_robot <- 2
```

#### Step 2: Run EFA without rotation

```{r s1 robot no rotation, echo = F}
# run EFA without rotation with N factors
efa_d1_robot_unrotatedN <- factanal(d1_robot, nfactors_d1_robot, r = "none")
print(efa_d1_robot_unrotatedN)

# get loadings for each factor
efa_d1_robot_unrotatedN_loadings <- getFactorLoadings(efa_d1_robot_unrotatedN)
```

#### Step 3: Run EFA with varimax rotation

```{r s1 robot varimax rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_robot_rotatedN <- factanal(d1_robot, nfactors_d1_robot, r = "none")
print(efa_d1_robot_rotatedN)

# get loadings for each factor
efa_d1_robot_rotatedN_loadings <- getFactorLoadings(efa_d1_robot_rotatedN)
```

##### Factor 1

```{r s1 robot varimax rotation F1, echo = F}
# examine factor 1
kable(efa_d1_robot_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 1")
```

##### Factor 2

```{r s1 robot varimax rotation F2, echo = F}
# examine factor 2
kable(efa_d1_robot_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s1 robot varimax rotation F3, echo = F}
# # examine factor 3
# kable(efa_d1_robot_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 3")
```

### Exploratory factor analysis: ALL conditions

#### Step 1: Determine how many factors to extract

```{r s1 all how many factors, echo = F}
howManyFactors(d1_all)
```

```{r s1 all set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_all <- 3
```

#### Step 2: Run EFA without rotation

```{r s1 all no rotation, echo = F}
# run EFA without rotation with N factors
efa_d1_all_unrotatedN <- factanal(d1_all, nfactors_d1_all, r = "none")
print(efa_d1_all_unrotatedN)

# get loadings for each factor
efa_d1_all_unrotatedN_loadings <- getFactorLoadings(efa_d1_all_unrotatedN)
```

#### Step 3: Run EFA with varimax rotation

```{r s1 all varimax rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_all_rotatedN <- factanal(d1_all, nfactors_d1_all, r = "none")
print(efa_d1_all_rotatedN)

# get loadings for each factor
efa_d1_all_rotatedN_loadings <- getFactorLoadings(efa_d1_all_rotatedN)
```

##### Factor 1

```{r s1 all varimax rotation F1, echo = F}
# examine factor 1
kable(efa_d1_all_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 1")
```

##### Factor 2

```{r s1 all varimax rotation F2, echo = F}
# examine factor 2
kable(efa_d1_all_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 2")
```

##### Factor 3

```{r s1 all varimax rotation F3, echo = F}
# examine factor 3
kable(efa_d1_all_rotatedN_loadings[[3]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 3")
```

## Predict latent variable structure for CFA in follow-up studies

### Extract latent variable structure

```{r s1 variable structure, echo = F}
# extract factor structure from study 1 efa (all conditions)
d1_fStructure <- extractFStructure(efa_d1_all_rotatedN)
kable(d1_fStructure, align = "l", 
      caption = "Study 1: Factor structure", digits = 2)
```

### Model 1: One factor (MIND)

```{r s1 cfa model: 1 factor, echo = F}
# set up model
model1_Factor1 <- paste0("mind =~ ", paste(names(d1_all), collapse = " + "))
model1 <- as.character(noquote(model1_Factor1))

# test model on study 1 data (all conditions)
d1_all_fit1 <- cfa(model1, d1_all)
print(summary(d1_all_fit1, fit.measures = TRUE))

# remove extraneous variables
rm(model1_Factor1)
```

### Model 2: Two factors (EXPERIENCE, AGENCY; see Gray et al., 2007)

```{r s1 cfa model: 2 factors, echo = F}
# set up model
model2 <- 'experience =~ hungry + fear + pain + pleasure + angry + desires + personality + conscious + pride + embarrassed + joy + tired + nauseated + safe + happy + depressed + calm + sounds + seeing + temperature + odors + depth + recognizing + love + guilt + disrespected + self_aware
agency =~ self_restraint + morality + remembering + emo_recog + goal + communicating + thoughts + computations + reasoning + beliefs + free_will + choices + intentions + recognizing + love + guilt + disrespected + self_aware'

# test model on study 1 data (all conditions)
d1_all_fit2 <- cfa(model2, d1_all)
print(summary(d1_all_fit2, fit.measures = TRUE))
```

### Model 3a: Three factors (F1, F2, F3; see Study 1)

```{r s1 cfa model: 3 factors (data-driven), echo = F}
# set up model
model3a_Factor1 <- paste0("Factor1 =~ ", paste(d1_fStructure$mc_Factor1[is.na(d1_fStructure$mc_Factor1) == F], collapse = " + "))
model3a_Factor2 <- paste0("Factor2 =~ ", paste(d1_fStructure$mc_Factor2[is.na(d1_fStructure$mc_Factor2) == F], collapse = " + "))
model3a_Factor3 <- paste0("Factor3 =~ ", paste(d1_fStructure$mc_Factor3[is.na(d1_fStructure$mc_Factor3) == F], collapse = " + "))
model3a_allFactors <- paste(model3a_Factor1, "\n", model3a_Factor2, "\n", model3a_Factor3, collapse = "")
model3a <- as.character(noquote(model3a_allFactors))

# test model on study 1 (all conditions)
d1_all_fit3a <- cfa(model3a, d1_all)
summary(d1_all_fit3a, fit.measures = TRUE)

# remove extraneous variables
rm(model3a_Factor1, model3a_Factor2, model3a_Factor3, model3a_allFactors)
```

### Model 3b: Three factors (AFFECT, AUTONOMY, PERCEPTION; see Weisman et al., 2015)

```{r s1 cfa model: 3 factors (a priori), echo = F}
# set up model
model3b <- 'affect =~ happy + depressed + fear + angry + calm + joy
autonomy =~ free_will + choices + self_restraint + intentions + goal
perception =~ sounds + seeing + temperature + odors + depth'

# test model on study 1 (all conditions)
d1_all_fit3b <- cfa(model3b, d1_all)
summary(d1_all_fit3b, fit.measures = TRUE)
```

### Compare models

```{r s1 compare model fits, echo = F}
# compare model fits
# anova(d1_all_fit1, d1_all_fit2, d1_all_fit3a)
anova(d1_all_fit1, d1_all_fit2, d1_all_fit3a, d1_all_fit3b)
```

# Study 2 (2016-01-12, 2 conditions, between-subjects - REPLICATION)

## Demographics

```{r s2 demographics, echo = F}
# make demographics tables
kable(demoSampleSize("study 2"), align = "l", digits = 2, 
      caption = "Study 2: Sample size")
kable(demoDuration("study 2"), align = "l", digits = 2,
      caption = "Study 2: Study duration (minutes)")
kable(demoAge("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant age (years; approximate)")
kable(demoGender("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant gender")
kable(demoRace("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant race/ethnicity")
kable(demoReligion("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant religion")
```

## Analyses

### Confirmatory factor analysis: ALL conditions

### Model 1: One factor (MIND)

```{r s2 cfa model: 1 factor, echo = F}
# test model on study 1 data (all conditions)
d2_all_fit1 <- cfa(model1, d2_all)
print(summary(d2_all_fit1, fit.measures = TRUE))
```

### Model 2: Two factors (EXPERIENCE, AGENCY; see Gray et al., 2007)

```{r s2 cfa model: 2 factors, echo = F}
# test model on study 1 data (all conditions)
d2_all_fit2 <- cfa(model2, d2_all)
print(summary(d2_all_fit2, fit.measures = TRUE))
```

### Model 3a: Three factors (F1, F2, F3; see Study 1)

```{r s2 cfa model: 3 factors (data-driven), echo = F}
# test model on study 1 (all conditions)
d2_all_fit3a <- cfa(model3a, d2_all)
summary(d2_all_fit3a, fit.measures = TRUE)
```

### Model 3b: Three factors (AFFECT, AUTONOMY, PERCEPTION; see Weisman et al., 2015)

```{r s2 cfa model: 3 factors (a priori), echo = F}
# test model on study 1 (all conditions)
d2_all_fit3b <- cfa(model3b, d2_all)
summary(d2_all_fit3b, fit.measures = TRUE)
```

### Compare models

```{r s2 compare model fits, echo = F}
# compare model fits
# anova(d2_all_fit1, d2_all_fit2, d2_all_fit3a)
anova(d2_all_fit1, d2_all_fit2, d2_all_fit3a, d2_all_fit3b)
```

# Study 3 (2016-01-10, 2 conditions, within-subjects)

## Demographics

```{r s3 demographics, echo = F}
# make demographics tables
kable(demoSampleSize("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Sample size")
kable(demoDuration("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Study duration (minutes)")
kable(demoAge("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant age (years; approximate)")
kable(demoGender("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Participant gender")
kable(demoRace("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant race/ethnicity")
kable(demoReligion("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant religion")
```

## Analyses

### Confirmatory factor analysis: ALL conditions

### Model 1: One factor (MIND)

```{r s3 cfa model: 1 factor, echo = F}
# test model on study 1 data (all conditions)
d3_all_fit1 <- cfa(model1, d3_all)
print(summary(d3_all_fit1, fit.measures = TRUE))
```

### Model 2: Two factors (EXPERIENCE, AGENCY; see Gray et al., 2007)

```{r s3 cfa model: 2 factors, echo = F}
# test model on study 1 data (all conditions)
d3_all_fit2 <- cfa(model2, d3_all)
print(summary(d3_all_fit2, fit.measures = TRUE))
```

### Model 3a: Three factors (F1, F2, F3; see Study 1)

```{r s3 cfa model: 3 factors (data-driven), echo = F}
# test model on study 1 (all conditions)
d3_all_fit3a <- cfa(model3a, d3_all)
summary(d3_all_fit3a, fit.measures = TRUE)
```

### Model 3b: Three factors (AFFECT, AUTONOMY, PERCEPTION; see Weisman et al., 2015)

```{r s3 cfa model: 3 factors (a priori), echo = F}
# test model on study 1 (all conditions)
d3_all_fit3b <- cfa(model3b, d3_all)
summary(d3_all_fit3b, fit.measures = TRUE)
```

### Compare models

```{r s3 compare model fits, echo = F}
# compare model fits
# anova(d3_all_fit1, d3_all_fit2, d3_all_fit3a)
anova(d3_all_fit1, d3_all_fit2, d3_all_fit3a, d3_all_fit3b)
```

# Study 4 (2016-01-14, 21 conditions, between-subjects)

## Demographics

```{r s4 demographics, echo = F}
# make demographics tables
kable(demoSampleSize("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Sample size")
kable(demoDuration("study 4"), align = "l", digits = 2,
      caption = "Study 4: Study duration (minutes)")
kable(demoAge("study 4"), align = "l", digits = 2,
      caption = "Study 4: Participant age (years; approximate)")
kable(demoGender("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Participant gender")
kable(demoRace("study 4"), align = "l", digits = 2,
      caption = "Study 4: Participant race/ethnicity")
kable(demoEducation("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Participant education")
```

## Analyses

### Confirmatory factor analysis: ALL conditions

### Model 1: One factor (MIND)

```{r s4 cfa model: 1 factor, echo = F}
# test model on study 1 data (all conditions)
d4_all_fit1 <- cfa(model1, d4_all)
print(summary(d4_all_fit1, fit.measures = TRUE))
```

### Model 2: Two factors (EXPERIENCE, AGENCY; see Gray et al., 2007)

```{r s4 cfa model: 2 factors, echo = F}
# test model on study 1 data (all conditions)
d4_all_fit2 <- cfa(model2, d4_all)
print(summary(d4_all_fit2, fit.measures = TRUE))
```

### Model 3a: Three factors (F1, F2, F3; see Study 1)

```{r s4 cfa model: 3 factors (data-driven), echo = F}
# test model on study 1 (all conditions)
d4_all_fit3a <- cfa(model3a, d4_all)
summary(d4_all_fit3a, fit.measures = TRUE)
```

### Model 3b: Three factors (AFFECT, AUTONOMY, PERCEPTION; see Weisman et al., 2015)

```{r s4 cfa model: 3 factors (a priori), echo = F}
# test model on study 1 (all conditions)
d4_all_fit3b <- cfa(model3b, d4_all)
summary(d4_all_fit3b, fit.measures = TRUE)
```

### Compare models

```{r s4 compare model fits, echo = F}
# compare model fits
# anova(d4_all_fit1, d4_all_fit2, d4_all_fit3a)
anova(d4_all_fit1, d4_all_fit2, d4_all_fit3a, d4_all_fit3b)
```

## Plot!

```{r s4 factor scores, echo = F}
# use best model to get factor scores by participant
d4_all_fit3b_predict <- predict(d4_all_fit3b)

# use dummy model to get subid into factor scores
# SHOULD UPDATE THIS SO THAT IT IS AUTOMATICALLY POPULATED FROM MODEL3B
model3b_dummy <- 'subid ~~ happy + depressed + fear + angry + calm + joy
subid ~~ free_will + choices + self_restraint + intentions + goal
subid ~~ sounds + seeing + temperature + odors + depth'
fit_dummy <- cfa(model3b_dummy, d4 %>%
                   select(subid, happy:pride))

data_dummy <- fit_dummy@Data@X[[1]]
d4_all_fit3b_predict <- data.frame(d4_all_fit3b_predict, 
                                   subid = data_dummy[,1])

d4_subids <- d4 %>% select(subid, condition) %>%
  mutate(subid_num = as.numeric(subid)) %>%
  rename(subid_cat = subid,
         subid = subid_num)

d4_factor_scores <- d4_all_fit3b_predict %>%
  full_join(d4_subids, by = "subid")

# remove extraneous variables
rm(d4_all_fit3b_predict, model3b_dummy, fit_dummy, data_dummy, d4_subids)
```

```{r s4 average factor scores by condition, echo = F}
d4_factor_scores_condition <- d4_factor_scores %>%
  group_by(condition) %>%
  summarise(affect_mean = mean(affect),
            affect_sd = sd(affect),
            affect_n = length(affect),
            autonomy_mean = mean(autonomy),
            autonomy_sd = sd(autonomy),
            autonomy_n = length(autonomy),
            perception_mean = mean(perception),
            perception_sd = sd(perception),
            perception_n = length(perception))

# d4_factor_scores_condition_mb <- d4_factor_scores %>%
#   gather(factor, score, c(affect, autonomy, perception)) %>%
#   multi_boot(column = "score",
#              summary_groups = c("condition", "factor"),
#              statistics_functions = c("ci_lower", "mean", "ci_upper"))
```

```{r s4 cfa plot: AFFECT vs. AUTONOMY, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = affect_mean, y = autonomy_mean, colour = condition), 
       data = d4_factor_scores_condition) +
  geom_errorbar(aes(ymin = autonomy_mean - autonomy_sd/sqrt(autonomy_n),
                    ymax = autonomy_mean + autonomy_sd/sqrt(autonomy_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = affect_mean - affect_sd/sqrt(affect_n),
                     xmax = affect_mean + affect_sd/sqrt(affect_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_discrete() +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: AFFECT vs. AUTONOMY\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: AFFECT",
       y = "Average score: AUTONOMY\n")
```

```{r s4 cfa plot: AFFECT vs. PERCEPTION, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = affect_mean, y = perception_mean, colour = condition), 
       data = d4_factor_scores_condition) +
  geom_errorbar(aes(ymin = perception_mean - perception_sd/sqrt(perception_n),
                    ymax = perception_mean + perception_sd/sqrt(perception_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = affect_mean - affect_sd/sqrt(affect_n),
                     xmax = affect_mean + affect_sd/sqrt(affect_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_discrete() +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: AFFECT vs. PERCEPTION\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: AFFECT",
       y = "Average score: PERCEPTION\n")
```

```{r s4 cfa plot: AUTONOMY vs. PERCEPTION, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = autonomy_mean, y = perception_mean, colour = condition), 
       data = d4_factor_scores_condition) +
  geom_errorbar(aes(ymin = perception_mean - perception_sd/sqrt(perception_n),
                    ymax = perception_mean + perception_sd/sqrt(perception_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = autonomy_mean - autonomy_sd/sqrt(autonomy_n),
                     xmax = autonomy_mean + autonomy_sd/sqrt(autonomy_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_discrete() +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: AUTONOMY vs. PERCEPTION\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: AUTONOMY",
       y = "Average score: PERCEPTION\n")
```

