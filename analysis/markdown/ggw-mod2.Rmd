---
title: 'GGW-mod2: Factor Analysis'
output:
  html_document:
    theme: flatly
    toc: yes
  pdf_document:
    toc: yes
---

# Setup

```{r workspace setup, message = F, echo = F}
# load libraries
library(devtools)
library(psych)
library(stats)
library(lavaan)
library(nonnest2)
library(nFactors)
library(langcog)
library(directlabels)
library(ggplot2)
library(knitr)
library(tidyr)
library(dplyr)

# clear workspace
rm(list = ls(all = T))
graphics.off()
```

```{r functions, message = F, echo = F}
# make cleanup function
cleanup <- function(datasource) {
  if(datasource %in% c("study 1", "study 2")) {
    
    # set target dataset
    if(datasource == "study 1"){d <- d_raw_study1}
    if(datasource == "study 2"){d <- d_raw_study2}
    
    # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH == 1, # exclude Ps who fail catch trials 
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2016 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode background and demographic variables
    d_clean <- d_clean_1 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             religion_buddhism:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3) %>%
      mutate( # deal with religion
        religion_buddhism = 
          factor(ifelse(is.na(religion_buddhism), "", "buddhism ")),
        religion_christianity = 
          factor(ifelse(is.na(religion_christianity), "", "christianity ")),
        religion_hinduism = 
          factor(ifelse(is.na(religion_hinduism), "", "hinduism ")),
        religion_islam = 
          factor(ifelse(is.na(religion_islam), "", "islam ")),
        religion_jainism = 
          factor(ifelse(is.na(religion_jainism), "", "jainism ")),
        religion_judaism = 
          factor(ifelse(is.na(religion_judaism), "", "judaism ")),
        religion_sikhism = 
          factor(ifelse(is.na(religion_sikhism), "", "sikhism ")),
        religion_other = 
          factor(ifelse(is.na(religion_other), "", "other ")),
        religion_none = 
          factor(ifelse(is.na(religion_none), "", "none ")),
        religion_prefno = 
          factor(ifelse(is.na(religion_prefno), "", "other_prefno ")),
        religion_cat = paste0(religion_buddhism, religion_christianity, 
                              religion_hinduism, religion_islam, 
                              religion_jainism, religion_judaism, 
                              religion_sikhism, religion_other, 
                              religion_none, religion_prefno),
        religion_cat2 = factor(sub(" +$", "", religion_cat)),
        religion_cat3 = factor(ifelse(grepl(" ", religion_cat2) == T, 
                                      "multireligious",
                                      as.character(religion_cat2)))) %>%
      select(study:gender, feedback:race_cat, religion_cat3) %>%
      rename(religion_cat = religion_cat3)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1)
  }
  
  if(datasource == "study 3") {
    
    # set target dataset
    d <- d_raw_study3
    
    # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH..characterL) | 
                                     is.na(CATCH..characterR), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH..characterL == 5, # exclude Ps who fail catch trials 
             CATCH..characterR == 5,
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2016 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode background and demographic variables
    d_clean_2 <- d_clean_1 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             religion_buddhism:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3) %>%
      mutate( # deal with religion
        religion_buddhism = 
          factor(ifelse(is.na(religion_buddhism), "", "buddhism ")),
        religion_christianity = 
          factor(ifelse(is.na(religion_christianity), "", "christianity ")),
        religion_hinduism = 
          factor(ifelse(is.na(religion_hinduism), "", "hinduism ")),
        religion_islam = 
          factor(ifelse(is.na(religion_islam), "", "islam ")),
        religion_jainism = 
          factor(ifelse(is.na(religion_jainism), "", "jainism ")),
        religion_judaism = 
          factor(ifelse(is.na(religion_judaism), "", "judaism ")),
        religion_sikhism = 
          factor(ifelse(is.na(religion_sikhism), "", "sikhism ")),
        religion_other = 
          factor(ifelse(is.na(religion_other), "", "other ")),
        religion_none = 
          factor(ifelse(is.na(religion_none), "", "none ")),
        religion_prefno = 
          factor(ifelse(is.na(religion_prefno), "", "other_prefno ")),
        religion_cat = paste0(religion_buddhism, religion_christianity, 
                              religion_hinduism, religion_islam, 
                              religion_jainism, religion_judaism, 
                              religion_sikhism, religion_other, 
                              religion_none, religion_prefno),
        religion_cat2 = factor(sub(" +$", "", religion_cat)),
        religion_cat3 = factor(ifelse(grepl(" ", religion_cat2) == T, 
                                      "multireligious",
                                      as.character(religion_cat2)))) %>%
      select(study:gender, feedback:race_cat, religion_cat3) %>%
      rename(religion_cat = religion_cat3)
    
    # rename response variables
    d_clean_3 <- d_clean_2
    names(d_clean_3) <- gsub("get", "", names(d_clean_3))
    names(d_clean_3) <- gsub("\\.", "", names(d_clean_3))
    names(d_clean_3) <- gsub("char", "_char", names(d_clean_3))
    names(d_clean_3)[names(d_clean_3) %in% c("_characterL", "_characterR")] <- 
      c("characterL", "characterR")
    
    # recode response variables (center)
    d_clean_4 <- d_clean_3
    for(i in 11:92) {
      d_clean_4[,i] <- d_clean_4[,i] - 4 # transform from 1 to 7 --> -3 to 3
    }
    
    # recode characterL vs. characterR as beetle vs. robot
    d_clean_5_demo <- d_clean_4 %>%
      select(study:condition, yob:religion_cat)
    
    d_clean_5_characterL <- d_clean_4 %>%
      mutate(target = characterL) %>%
      select(study, subid, target, happy_characterL:CATCH_characterL)
    names(d_clean_5_characterL) <- gsub("_characterL", "", 
                                        names(d_clean_5_characterL))
    
    d_clean_5_characterR <- d_clean_4 %>%
      mutate(target = characterR) %>%
      select(study, subid, target, happy_characterR:CATCH_characterR)
    names(d_clean_5_characterR) <- gsub("_characterR", "", 
                                        names(d_clean_5_characterR))
    
    d_clean <- d_clean_5_characterL %>%
      full_join(d_clean_5_characterR) %>%
      full_join(d_clean_5_demo) %>%
      select(study, subid, date:religion_cat, target:CATCH)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1, d_clean_2, d_clean_3, d_clean_4, d_clean_5_characterL, 
       d_clean_5_characterR, d_clean_5_demo, i)
  }
  
  if(datasource == "study 4") {
    
    # set target dataset
    d <- d_raw_study4

        # enact exclusionary criteria
    d_clean_1 <- d %>%
      mutate(finished_mod = ifelse(is.na(CATCH), 0,
                                   ifelse(finished == 1, 1,
                                          0.5))) %>%
      filter(CATCH == 1, # exclude Ps who fail catch trials 
             finished_mod != 0) %>% # exclude Ps who did not complete task
      mutate(yob_correct = as.numeric(
        ifelse(as.numeric(as.character(yob)) > 1900 & 
                 as.numeric(as.character(yob)) < 2000, 
               as.numeric(as.character(yob)), NA)), # correct formatting in yob
        age_approx = 2016 - yob_correct) %>% # calculate approximate age
      mutate(gender = factor(gender, levels = c(1, 2, 0), 
                             labels = c("m", "f", "other"))) %>%
      filter(age_approx >= 18) # exclude Ps who are younger than 18 years
    
    # recode one character
    d_clean_2 <- d_clean_1 %>%
      mutate(condition = factor(ifelse(
        grepl("vegetative", as.character(condition)), "pvs",
        ifelse(grepl("blue", as.character(condition)), "bluejay",
               as.character(condition)))))
    
    # recode background and demographic variables
    d_clean <- d_clean_2 %>%
      mutate( # deal with study number
        study = factor(study)) %>%
      mutate( # deal with study duration
        duration = as.numeric(difftime(strptime(end_time, "%I:%M:%S"),
                                       strptime(start_time, "%I:%M:%S"),
                                       units = "mins"))) %>%
      mutate( # deal with race
        race_asian_east = 
          factor(ifelse(is.na(race_asian_east), "", "asian_east ")),
        race_asian_south = 
          factor(ifelse(is.na(race_asian_south), "", "asian_south ")),
        race_asian_other = 
          factor(ifelse(is.na(race_asian_other), "", "asian_other ")),
        race_black = 
          factor(ifelse(is.na(race_black), "", "black ")),
        race_hispanic = 
          factor(ifelse(is.na(race_hispanic), "", "hispanic ")),
        race_middle_eastern = 
          factor(ifelse(is.na(race_middle_eastern), "", "middle_eastern ")),
        race_native_american = 
          factor(ifelse(is.na(race_native_american), "", "native_american ")),
        race_pac_islander = 
          factor(ifelse(is.na(race_pac_islander), "", "pac_islander ")),
        race_white = 
          factor(ifelse(is.na(race_white), "", "white ")),
        race_other_prefno = 
          factor(ifelse(is.na(race_other_prefno), "", "other_prefno ")),
        race_cat = paste0(race_asian_east, race_asian_south, race_asian_other,
                          race_black, race_hispanic, race_middle_eastern,
                          race_native_american, race_pac_islander, race_white,
                          race_other_prefno),
        race_cat2 = factor(sub(" +$", "", race_cat)),
        race_cat3 = factor(ifelse(grepl(" ", race_cat2) == T, "multiracial",
                                  as.character(race_cat2)))) %>%
      select(study, subid:end_time, duration, finished:gender, 
             education:age_approx, race_cat3) %>%
      rename(race_cat = race_cat3)
    
    # remove extraneous dfs and variables
    rm(d, d_clean_1, d_clean_2)
  }
  
  # do transformation to reduce skewness
  
  # return cleaned dataset
  return(d_clean)
}

# make function for examining exclusion of participants
excludedCounts <- function(datasource) {
  
  # set datasource
  if(datasource == "study 1"){
    d <- d1
    d_raw <- d_raw_study1
  }
  if(datasource == "study 2"){
    d <- d2
    d_raw <- d_raw_study2
  }
  if(datasource == "study 3"){
    d <- d3
    d_raw <- d_raw_study3
  }
  if(datasource == "study 4"){
    d <- d4
    d_raw <- d_raw_study4
  }
  
  # get subids of successful participants
  d_subids <- levels(factor(as.character(d$subid)))
  
  # get subids of excluded participants
  d_excluded <- d_raw %>%
    filter(is.element(subid, d_subids) == FALSE) %>%
    select(condition, subid, finished, starts_with("CATCH"), yob)

  # count excluded participants
  d_excluded_n <- length(d_excluded$subid)
  
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    # count participants who did not finish
    d_excluded_unfinished <- d_excluded %>%
      filter(is.na(CATCH) == T,
             finished != 1) %>%
      select(subid) %>%
      c()
    
    # count participants who finished, but failed catch trial
    d_excluded_CATCH <- d_excluded %>%
      filter(is.element(subid, d_excluded_unfinished$subid) == FALSE) %>%
      filter(CATCH != 1) %>%
      select(subid) %>%
      c()
  }
  
  if(datasource == "study 3") {
    # count participants who did not finish
    d_excluded_unfinished <- d_excluded %>%
      filter(is.na(CATCH..characterL) == T,
             is.na(CATCH..characterR) == T,
             finished != 1) %>%
      select(subid) %>%
      c()
    
    # count participants who finished, but failed catch trial
    d_excluded_CATCH <- d_excluded %>%
      filter(is.element(subid, d_excluded_unfinished$subid) == FALSE) %>%
      filter(CATCH..characterL != 5 | CATCH..characterR != 5) %>%
      select(subid) %>%
      c()
  }
  
  # count participants who finished and passed catch trial, 
  # but did not provide year of birth
  d_excluded_no_yob <- d_excluded %>%
    filter(is.element(subid, d_excluded_unfinished$subid) == FALSE,
           is.element(subid, d_excluded_CATCH$subid) == FALSE) %>%
    mutate(yob = as.numeric(as.character(yob))) %>%
    filter(is.na(yob) | yob < 1899 | nchar(as.character(yob)) != 4) %>%
    select(subid) %>%
    c()
  
  # count participants who finished and passed catch trial, 
  # but did not provide year of birth
  d_excluded_young <- d_excluded %>%
    filter(is.element(subid, d_excluded_unfinished$subid) == FALSE,
           is.element(subid, d_excluded_CATCH$subid) == FALSE,
           is.element(subid, d_excluded_no_yob$subid) == FALSE) %>%
    mutate(yob = as.numeric(as.character(yob))) %>%
    filter(is.na(yob) | 2016 - yob < 18) %>%
    select(subid) %>%
    c()
  
  # sum up excluded participants by category
  total <- sum(length(d_excluded_unfinished$subid),
               length(d_excluded_CATCH$subid),
               length(d_excluded_no_yob$subid),
               length(d_excluded_young$subid))
  
  # calculate counts
  excluded_counts <- 
    data.frame("did_not_finish" = length(d_excluded_unfinished$subid),
               "failed_catch_trial" = length(d_excluded_CATCH$subid),
               "did_not_provide_yob" = length(d_excluded_no_yob$subid),
               "too_young" = length(d_excluded_young$subid),
               "TOTAL_excluded" = total,
               "TOTAL_participated" = length(d$subid),
               "OVERALL_TOTAL" = sum(total, length(d$subid)))
  
  if(total != d_excluded_n) {
    stop("Error: 4 sources of exclusion do not add up to total.")
    } else {
      return(excluded_counts)
    }
}

# make function for stripping dataframes for dimension reducation
makeDRDF <- function(datasource, chosenCondition) {
  
  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # rename variables for ease of function applpication
    d <- d3 %>%
      rename(order = condition,
             condition = target)
    
    # rename subids by condition if collapses across conditions
    d <- d %>%
      mutate(subid = paste(condition, subid, sep = "_"))
  }
  if(datasource == "study 4"){d <- d4}
  
  # filter by condition if specified
  if(chosenCondition %in% c("beetle", "robot")) {
    d <- d %>% filter(condition == chosenCondition)
  }
  
  # make stripped dataframe for dimension reducation analyses
  d_strip <- d %>%
    select(subid, happy:pride)
  d_strip <- data.frame(d_strip[,-1], row.names = d_strip[,1])
  
  # return stripped dataframe
  return(d_strip)
}

# make demographics functions
demoSampleSize <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # rename variables for ease of function applpication
    d <- d3 %>%
      rename(order = condition,
             condition = target)
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  sample_size <- vector()
  for(i in levels(d$condition)) {
    sample_size[as.character(i)] <- 
      as.numeric(d %>% filter(condition == i) %>% select(subid) %>% 
                   unique() %>% count())
  }

  # add total sample size  
  sample_size["all"] <- as.numeric(d %>% select(subid) %>% 
                                     unique() %>% count())
  
  # make into dataframe for using kable
  sample_size <- data.frame(sample_size) %>%
    add_rownames() %>%
    rename(condition = rowname,
           n = sample_size)
  
  # return dataframe for using kable
  return(sample_size)
}
demoDuration <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # recode variables for ease of function applpication
    d <- d3 %>%
      mutate(condition = "within-subjects")
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  duration <- d %>%
    group_by(condition) %>%
    summarise(min_duration = min(duration),
              max_duration = max(duration),
              median_duration = median(duration),
              mean_duration = mean(duration),
              sd_duration = sd(duration))

  # add total duration
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    all <- d %>%
      summarise(min_duration = min(duration),
                max_duration = max(duration),
                median_duration = median(duration),
                mean_duration = mean(duration),
                sd_duration = sd(duration)) %>%
      mutate(condition = "all")
    duration <- rbind(duration, all) # not sure why full_join doesn't work    
  }

  # return dataframe for using kable
  return(duration)
}
demoAge <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){
    # recode variables for ease of function applpication
    d <- d3 %>%
      mutate(condition = "within-subjects")
  }
  if(datasource == "study 4"){d <- d4}

  # get sample size per condition
  age <- d %>%
    group_by(condition) %>%
    summarise(min_age = min(age_approx),
              max_age = max(age_approx),
              median_age = median(age_approx),
              mean_age = mean(age_approx),
              sd_age = sd(age_approx))

  # add total age
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    all <- d %>%
      summarise(min_age = min(age_approx),
                max_age = max(age_approx),
                median_age = median(age_approx),
                mean_age = mean(age_approx),
                sd_age = sd(age_approx)) %>%
      mutate(condition = "all")
    age <- full_join(age, all)
  }

  # return dataframe for using kable
  return(age)
}
demoGender <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}
  if(datasource == "study 4"){d <- d4}

  # get gender per condition and overall
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    gender <- data.frame(addmargins(with(d, table(condition, gender)))) %>%
      filter(gender != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    gender <- data.frame(with(d, table(gender))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, gender, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    gender <- gender %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, gender) %>%
    spread(gender, n)
  }
  
  if(datasource == "study 4") {
    gender <- gender %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c(levels(d$condition), "all"))) %>%
    arrange(condition, gender) %>%
    spread(gender, n)
  }
  
  # return dataframe for using kable
  return(gender)
}
demoRace <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}
  if(datasource == "study 4"){d <- d4}

  # get race per condition and overall
  if(datasource %in% c("study 1", "study 2", "study 4")) {
    race <- data.frame(addmargins(with(d, table(condition, race_cat)))) %>%
      filter(race_cat != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    race <- data.frame(with(d, table(race_cat))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, race_cat, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    race <- race %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, race_cat) %>%
    spread(race_cat, n)
  }
  
  if(datasource == "study 4") {
    race <- race %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c(levels(d$condition), "all"))) %>%
    arrange(condition, race_cat) %>%
    spread(race_cat, n)
  }
  
  # return dataframe for using kable
  return(race)
}
demoReligion <- function(datasource) {

  # set target dataset
  if(datasource == "study 1"){d <- d1}
  if(datasource == "study 2"){d <- d2}
  if(datasource == "study 3"){d <- d3}

  # get religion per condition and overall
  if(datasource %in% c("study 1", "study 2")) {
    religion <- data.frame(addmargins(with(d, table(condition, religion_cat)))) %>%
      filter(religion_cat != "Sum") %>%
      rename(n = Freq)
  }
  
  if(datasource == "study 3") {
    religion <- data.frame(with(d, table(religion_cat))) %>%
      rename(n = Freq) %>%
      mutate(condition = "Sum") %>%
      select(condition, religion_cat, n)
  }
  
  if(datasource %in% c("study 1", "study 2", "study 3")) {
    religion <- religion %>%
    mutate(condition = factor(ifelse(condition == "Sum", 
                                     "all", as.character(condition)),
                              levels = c("beetle", "robot", "all"))) %>%
    arrange(condition, religion_cat) %>%
    spread(religion_cat, n)
  }
  
  # return dataframe for using kable
  if(datasource == "study 4"){
    stop("Religion information not available for Study 4")
  } else {return(religion)}
}
demoEducation <- function(datasource) {

  # set target dataset
  if(datasource == "study 4"){d <- d4}
  
  # get education per condition and overall
  if(datasource == "study 4") {
    education <- 
      data.frame(addmargins(with(d, table(condition, education)))) %>%
      filter(education != "Sum") %>%
      rename(n = Freq) %>%
      mutate(condition = factor(ifelse(condition == "Sum",
                                       "all", as.character(condition)),
                                levels = c(levels(d$condition), "all")),
             education = factor(education,
                                levels = c(1:7, 0),
                                labels = c("some_HS",
                                           "HS_diploma",
                                           "some_college",
                                           "associates",
                                           "bachelors",
                                           "some_grad",
                                           "grad",
                                           "pref_no"))) %>%
      arrange(condition, education) %>%
      spread(education, n)
  }
  
  # return dataframe for using kable
  if(datasource %in% c("study 1", "study 2", "study 3")){
    stop("Education information not available for Studies 1-3")
  } else {return(education)}
}

# make scree plot to determine how many factors to extract
howManyFactors <- function (df) {
  # count eigenvalues > 1.0 (using correlation matrix)
  countEigen <- function(df) {
    eigenVals <- eigen(cor(df))$values
    nGreaterThan1 <- length(eigenVals[eigenVals > 1.00])
    nGreaterThan5Per <- length(eigenVals[eigenVals/40 > 0.05])
    results <- c("cutoff" = nGreaterThan1, "propVar" = nGreaterThan5Per)
    return(results)
  }

  # scree plot: look for elbow
  scree_df <- scree(df, main = "Scree plot")
  
  # eigenvalues: count how many > 1
  text(x = 20, y = 12, 
       labels = paste(countEigen(df)["cutoff"], 
                      "eigenvalues > 1.00 (for EFA)"))

  # eigenvalues: count how account for > 5% variance
  text(x = 20, y = 10, 
       labels = paste(countEigen(df)["propVar"], 
                      "eigenvalues > 5% variance (for EFA)"))
  
  # very simple structure: look at different indices
  # vss_unrotated_df <- VSS(df, n = 15, 
  #                                rotate = "none", plot = FALSE)
  # vss_rotated_df <- VSS(df, n = 15, 
  #                              rotate = "oblimin", cor = "cor", plot = FALSE)
}

# get factor loadings for some efa
getFactorLoadings <- function(efa) {
  factorLoadingsList <- list()
  for(i in 1:efa$factors) {
    factorNum <- paste0("F", i)
    df <- data.frame(X = sort(loadings(efa)[,i], decreasing = T))
    names(df) <- factorNum
    factorLoadingsList[[i]] <- df
  }
  return(factorLoadingsList)
}

# extract factor structure
# NOTE only works for 3 factor solutions!!
extractFStructure <- function(efa) {
  # examine factor loadings from s1 to structure latent variables for s2
  d_structure <- data.frame(loadings(efa)[]) %>%
    add_rownames(var = "mc") %>%
    mutate(
      bestFactor =
        # NOTE: ONLY TAKES POSITIVE LOADINGS: NEED TO IMPLEMENT 
        # TRANSLATION INTO MODEL IN ORDER TO INCLUDE ABSOLUTE VALUES 
        # (wrap all "MR*" with abs)
        ifelse(MR1 == MR2 & MR1 == MR3,
               "all tied",
               ifelse(MR1 == MR2,
                      "MR1 and MR2 tied",
                      ifelse(MR1 == MR3,
                             "MR1 and MR3 tied",
                             ifelse(MR2 == MR3,
                                    "MR2 and MR3 tied",
                                    ifelse(MR1 > MR2,
                                           ifelse(MR1 > MR3,
                                                  "MR1",
                                                  "MR3"),
                                           ifelse(MR2 > MR3,
                                                  "MR2",
                                                  "MR3"))))))) %>%
    mutate(bestFactor = factor(bestFactor))
  
  d_structure_MR1 <- d_structure %>%
    filter(bestFactor == "MR1") %>%
    arrange(desc(MR1)) %>%
    select(mc, MR1) %>%
    rename(mc_MR1 = mc,
           loading_MR1 = MR1) %>%
    add_rownames(var = "order")
  
  d_structure_MR2 <- d_structure %>%
    filter(bestFactor == "MR2") %>%
    arrange(desc(MR2)) %>%
    select(mc, MR2) %>%
    rename(mc_MR2 = mc,
           loading_MR2 = MR2) %>%
    add_rownames(var = "order")
  
  d_structure_MR3 <- d_structure %>%
    filter(bestFactor == "MR3") %>%
    arrange(desc(MR3)) %>%
    select(mc, MR3) %>%
    rename(mc_MR3 = mc,
           loading_MR3 = MR3) %>%
    add_rownames(var = "order")
  
  d_structure_allFactors <- d_structure_MR1 %>%
    full_join(d_structure_MR2) %>%
    full_join(d_structure_MR3)
  
  # return table of factor structure
  return(d_structure_allFactors)
}

# run customized CFA
customCFA <- function(d, model) {
  if(chosenVarCoding == "continuous") {
    cfa <- cfa(model, d, estimator = chosenEstimator) 
  } else if(chosenVarCoding == "ordinal") {
    cfa <- cfa(model, d, ordered = names(d), estimator = chosenEstimator)
  }
  return(cfa)
}

# compare non-nested models if possible
# NOTE: currently only possible if models were fitted to continuous data using maximum likelihood estimator
customVuong <- function(chosenDD, chosenWDM, chosenGGW) {
  # check if conditions are met before running tests
  if(chosenVarCoding != "continuous" | chosenEstimator != "ML") {
    stop("Variables must be considered continuous (ordered = NULL), and models must be estimated using maximum likelihood (estimator = 'ML').")
  }

  # find winner of comparison 1
  C1 <- vuongtest(chosenDD, chosenWDM)
  if(C1$p_LRT[1] < 0.05) {
    betterModelC1 <- "DD>WDM"
  } else if(C1$p_LRT[2] < 0.05) {
    betterModelC1 <- "WDM>DD"
  } else {
    betterModelC1 <- "DD=WDM=DD"
  }
  
  # find winner of comparison 2
  C2 <- vuongtest(chosenDD, chosenGGW)
  if(C2$p_LRT[1] < 0.05) {
    betterModelC2 <- "DD>GGW"
  } else if(C2$p_LRT[2] < 0.05) {
    betterModelC2 <- "GGW>DD"
  } else {
    betterModelC2 <- "DD=GGW=DD"
  }
  
  # find winner of comparison 3
  C3 <- vuongtest(chosenGGW, chosenWDM)
  if(C3$p_LRT[1] < 0.05) {
    betterModelC3 <- "GGW>WDM"
  } else if(C3$p_LRT[2] < 0.05) {
    betterModelC3 <- "WDM>GGW"
  } else {
    betterModelC3 <- "GGW=WDM=GGW"
  }
  
  # gather winners
  wins <- c(betterModelC1, betterModelC2, betterModelC3)
  
  # tally up wins
  winCounts <- c(DD = length(grep("DD>", wins)),
                 WDM = length(grep("WDM>", wins)),
                 GGW = length(grep("GGW>", wins)))
  
  # look for ties, otherwise declare winner
  if(winCounts["DD"] == winCounts["WDM"] & 
     winCounts["DD"] == winCounts["GGW"]) {
    winner <- c("DD", "WDM", "GGW")
  } else if(winCounts["DD"] == winCounts["WDM"]) {
    winner <- c("DD", "WDM")
  } else if(winCounts["DD"] == winCounts["GGW"]) {
    winner <- c("DD", "GGW")
  } else if(winCounts["GGW"] == winCounts["WDM"]) {
    winner <- c("GGW", "WDM")
  } else {
    winner <- names(which.max(winCounts))
  }
  
  # NOTE: all set up so that model 2 predicted to be better than model 1
  results <- list("mod1_v_mod2" = vuongtest(chosenDD, chosenWDM), 
                  "mod1_v_mod3" = vuongtest(chosenDD, chosenGGW), 
                  "mod3_v_mod2" = vuongtest(chosenGGW, chosenWDM),
                  "winner" = names(which.max(winCounts)))
  return(results)
}

# set 21-color palette (thank to Paul Tol: https://personal.sron.nl/~pault/colourschemes.pdf)
tol21rainbow = c("#771155", "#AA4488", "#CC99BB", "#114477", "#4477AA", "#77AADD", "#117777", "#44AAAA", "#77CCCC", "#117744", "#44AA77", "#88CCAA", "#777711", "#AAAA44", "#DDDD77", "#774411", "#AA7744", "#DDAA77", "#771122", "#AA4455", "#DD7788")
```

```{r modeling decisions, echo = F}
# for current purposes always choose minimal residual (fm = "minres") instead of ML because of non-normality

# for EFAs, what kind of correlation?
chosenCorType <- "cor" # pearson correlation, less appropriate for ordinal data but 7-point likert scale might be ok
# chosenCorType <- "poly" # polychoric correlation, appropriate for ordinal data but seems to throw errors

# for CFAs, treat variables as continuous or ordinal?
chosenVarCoding <- "continuous" # less true (bc of skewed data) but faster and able to compare non-nested models using vuongtest
# chosenVarCoding <- "ordinal" # truer but slower and impossible to compare non-nested models

# for CFAs, what estimator to use?
chosenEstimator <- "ML" # maximum likelihood, probably less true (bc of skewed data) but able to compare non-nested models using vuongtest
# chosenEstimator <- "default"

kable(data.frame("EFA_correlation" = chosenCorType,
                 "CFA_coding" = chosenVarCoding,
                 "CFA_estimator" = chosenEstimator))
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Data preparation

```{r data upload, message = F, echo = F}
# study 1 (2015-12-15, 2 conditions, between-subjects)
d_raw_study1 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v1 (2 conditions between)/GGWmod2_v1_clean.csv") %>%
  mutate(study = "study 1")

# study 2 (2016-01-12, 2 conditions, between-subjects - REPLICATION)
d_raw_study2 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v1 (replication)/GGWmod2_v1_replication_clean.csv") %>%
  mutate(study = "study 2")

# study 3 (2016-01-10, 2 conditions, within-subjects)
d_raw_study3 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v2 (2 conditions within)/GGWmod2_v2_withinsubjects_clean.csv") %>%
  mutate(study = "study 3")

# study 4 (2016-01-14, 21 conditions, between-subjects)
d_raw_study4 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/GGW-mod/ggw-mod2/mturk/v3 (21 conditions between)/GGWmod2_v3_many_characters_clean.csv") %>%
  mutate(study = "study 4")
```

```{r data cleanup, message = F, echo = F}
# clean up datasets
d1 <- cleanup("study 1")
d2 <- cleanup("study 2")
d3 <- cleanup("study 3")
d4 <- cleanup("study 4")
```

```{r dataframes for dimension reducation, message = F, echo = F}
# make dataframes for s1
d1_beetle <- makeDRDF("study 1", "beetle")
d1_robot <- makeDRDF("study 1", "robot")
d1_all <- makeDRDF("study 1", "all")

# make dataframes for study 2
d2_beetle <- makeDRDF("study 2", "beetle")
d2_robot <- makeDRDF("study 2", "robot")
d2_all <- makeDRDF("study 2", "all")

# make dataframes for study 3
d3_beetle <- makeDRDF("study 3", "beetle")
d3_robot <- makeDRDF("study 3", "robot")
d3_all <- makeDRDF("study 3", "all")

# make dataframes for study 4
d4_all <- makeDRDF("study 4", "all")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Data examination

```{r distributions, message = F, echo = F, fig.width = 15, fig.height = 3}
# # verify that data is too skewed to assume normality
# allData <- d1 %>%
#   select(study, subid, condition, happy:pride) %>%
#   full_join(d2 %>% select(study, subid, happy:pride)) %>%
#   full_join(d3 %>% select(study, subid, happy:pride)) %>%
#   full_join(d4 %>% select(study, subid, happy:pride)) %>%
#   gather(mc, response, happy:pride) %>%
#   mutate(log_response = log(response + 4),
#          recip_response = 1/(response + 4),
#          sqrt_response = sqrt(response + 4),
#          logsqrt_response = log(sqrt(response + 4)))
# 
# ggplot(allData) +
#   geom_histogram(aes(x = response)) + 
#   facet_grid(study ~ mc) +
#   theme_bw()
```

```{r sphericity, message = F, echo = F}
# conduct bartlett's test of sphericity for all correlation matrices
# # study 1
# cortest.bartlett(cor(d1_beetle), n = nrow(d1_beetle))
# cortest.bartlett(cor(d1_robot), n = nrow(d1_robot))
# cortest.bartlett(cor(d1_all), n = nrow(d1_all))
# 
# # study 2
# cortest.bartlett(cor(d2_beetle), n = nrow(d2_beetle))
# cortest.bartlett(cor(d2_robot), n = nrow(d2_robot))
# cortest.bartlett(cor(d2_all), n = nrow(d2_all))
# 
# # study 3
# cortest.bartlett(cor(d3_beetle), n = nrow(d3_beetle))
# cortest.bartlett(cor(d3_robot), n = nrow(d3_robot))
# cortest.bartlett(cor(d3_all), n = nrow(d3_all))
# 
# # study 4
# cortest.bartlett(cor(d4_all), n = nrow(d4_all))
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Study 1 (2015-12-15, 2 conditions, between-subjects)

## Demographics

```{r s1 demographics, echo = F}
# examine exclusion
kable(excludedCounts("study 1"), align = "l",
      caption = "Study 1: Exclusion")

# make demographics tables
kable(demoSampleSize("study 1"), align = "l", digits = 2,
      caption = "Study 1: Sample size")
kable(demoDuration("study 1"), align = "l", digits = 2,
      caption = "Study 1: Study duration (minutes)")
kable(demoAge("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant age (years; approximate)")
kable(demoGender("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant gender")
kable(demoRace("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant race/ethnicity")
kable(demoReligion("study 1"), align = "l", digits = 2,
      caption = "Study 1: Participant religion")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Exploratory factor analysis

### EFA: BEETLE condition

#### Step 1: Determine how many factors to extract

```{r s1 beetle how many factors, echo = F}
howManyFactors(d1_beetle)
```

```{r s1 beetle set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_beetle <- 2
```

#### Step 2: Run EFA without rotation

```{r s1 beetle no rotation, echo = F}
# run EFA without rotation with N factors
efa_d1_beetle_unrotated <- fa(d1_beetle, 15, rotate = "none",
                              cor = "cor", fm = "minres")
print(efa_d1_beetle_unrotated)

# get loadings for each factor
efa_d1_beetle_unrotated_loadings <- getFactorLoadings(efa_d1_beetle_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s1 beetle oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_beetle_rotatedN <- fa(d1_beetle, nfactors_d1_beetle, 
                             rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d1_beetle_rotatedN)

# get loadings for each factor
efa_d1_beetle_rotatedN_loadings <- getFactorLoadings(efa_d1_beetle_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s1 beetle oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d1_beetle_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 1")
```

##### Factor 2

```{r s1 beetle oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d1_beetle_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s1 beetle oblimin rotation F3, echo = F}
# # examine factor 3
# kable(efa_d1_beetle_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 1, BEETLE condition: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

### EFA: ROBOT condition

#### Step 1: Determine how many factors to extract

```{r s1 robot how many factors, echo = F}
howManyFactors(d1_robot)
```

```{r s1 robot set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_robot <- 2
```

#### Step 2: Run EFA without rotation

```{r s1 robot no rotation, echo = F}
# run EFA without rotation with N factors
efa_d2_robot_unrotated <- fa(d2_robot, 15, rotate = "none",
                             cor = "cor", fm = "minres")
print(efa_d2_robot_unrotated)

# get loadings for each factor
efa_d2_robot_unrotated_loadings <- getFactorLoadings(efa_d2_robot_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s1 robot oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_robot_rotatedN <- fa(d1_robot, nfactors_d1_robot, 
                            rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d1_robot_rotatedN)

# get loadings for each factor
efa_d1_robot_rotatedN_loadings <- getFactorLoadings(efa_d1_robot_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s1 robot oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d1_robot_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 1")
```

##### Factor 2

```{r s1 robot oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d1_robot_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s1 robot oblimin rotation F3, echo = F}
# # examine factor 3
# kable(efa_d1_robot_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 1, ROBOT condition: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

### EFA: ALL conditions

#### Step 1: Determine how many factors to extract

```{r s1 all how many factors, echo = F}
howManyFactors(d1_all)
```

```{r s1 all set nfactors, echo = F}
# set number of factors to extract
nfactors_d1_all <- 3
```

#### Step 2: Run EFA without rotation

```{r s1 all no rotation, echo = F}
# run EFA without rotation with N factors
efa_d1_all_unrotated <- fa(d1_all, 15, rotate = "none", 
                           cor = "cor", fm = "minres")
print(efa_d1_all_unrotated)

# get loadings for each factor
efa_d1_all_unrotated_loadings <- getFactorLoadings(efa_d1_all_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s1 all oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d1_all_rotatedN <- fa(d1_all, nfactors_d1_all, 
                          rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d1_all_rotatedN)

# get loadings for each factor
efa_d1_all_rotatedN_loadings <- getFactorLoadings(efa_d1_all_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s1 all oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d1_all_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 1")
```

##### Factor 2

```{r s1 all oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d1_all_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 2")
```

##### Factor 3

```{r s1 all oblimin rotation F3, echo = F}
# examine factor 3
kable(efa_d1_all_rotatedN_loadings[[3]], 
      align = "l", caption = "Study 1, ALL conditions: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Predict latent variable structure for CFA in follow-up studies

### Extract latent variable structure

```{r s1 variable structure, echo = F}
# extract factor structure from study 1 efa (all conditions)
d1_fStructure <- extractFStructure(efa_d1_all_rotatedN)
kable(d1_fStructure, align = "l", 
      caption = "Study 1: Factor structure", digits = 2)
```

### ModelDD: Data-driven, three factors (MR1, MR2, MR3; see Study 1)

```{r s1 cfa modelDD: 3 factors (data-driven), echo = F}
# set up model based on EFA
# NOTE: ONLY WORKS FOR POSITIVE LOADINGS!!
modelDD_MR1 <- paste0("MR1 =~ ", paste(d1_fStructure$mc_MR1[is.na(d1_fStructure$mc_MR1) == F], collapse = " + "))
modelDD_MR2 <- paste0("MR2 =~ ", paste(d1_fStructure$mc_MR2[is.na(d1_fStructure$mc_MR2) == F], collapse = " + "))
modelDD_MR3 <- paste0("MR3 =~ ", paste(d1_fStructure$mc_MR3[is.na(d1_fStructure$mc_MR3) == F], collapse = " + "))
modelDD_allFactors <- paste(modelDD_MR1, "\n", modelDD_MR2, "\n", modelDD_MR3, collapse = "")
modelDD <- as.character(noquote(modelDD_allFactors))

# test model
d1_all_fitDD <- customCFA(d1_all, modelDD)
summary(d1_all_fitDD, fit.measures = TRUE)

# remove extraneous variables
rm(modelDD_MR1, modelDD_MR2, modelDD_MR3, modelDD_allFactors)
```

### ModelWDM: Theoretical, three factors (SOCIAL-EMOTIONAL, BIOLOGICAL, PERCEPTUAL; see Weisman et al., 2015)

```{r s1 cfa modelWDM: 3 factors (theory-based), echo = F}
# OLD VERSION, NOT INFORMED BY DATA:
# # set up model based on Weisman et al (2015)
# modelWDM <- 'affect =~ happy + depressed + fear + angry + calm + joy
# perception =~ sounds + seeing + temperature + odors + depth
# autonomy =~ free_will + choices + self_restraint + intentions + goal'

# set up model based on Weisman et al (2015)
modelWDM <- 'soc_emo =~ happy + depressed + fear + angry + calm + joy + love + guilt + disrespected + embarrassed + pride
biological =~ hungry + tired + pain + nauseated + safe + pleasure
perceptual =~ sounds + seeing + temperature + odors + depth'

# test model
d1_all_fitWDM <- customCFA(d1_all, modelWDM)
summary(d1_all_fitWDM, fit.measures = TRUE)
```

#### ModelGGW: Theoretical, two factors (AGENCY, EXPERIENCE; see Gray et al., 2007)

```{r s1 cfa modelGGW: 2 factors (theory-based), echo = F}
# set up model based on Weisman et al (2015)
modelGGW <- ggw_model <- 'experience =~ hungry + fear + pain + pleasure + angry + desires + personality + conscious + pride + embarrassed + joy
agency =~ self_restraint + morality + remembering + emo_recog + goal + communicating + thoughts'

# test model
d1_all_fitGGW <- customCFA(d1_all, modelGGW)
summary(d1_all_fitGGW, fit.measures = TRUE)
```

#### Compare models (not yet implemented)

```{r s1 cfa model comparison}
# MODELS HAVE DIFFERENT SETS OF VARIABLES, MIGHT NOT WORK
# # compare models (iff continuous and ML)
# customVuong(chosenDD = d1_all_fitDD, 
#             chosenWDM = d1_all_fitWDM, 
#             chosenGGW = d1_all_fitGGW)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Study 2 (2016-01-12, 2 conditions, between-subjects - REPLICATION)

## Demographics

```{r s2 demographics, echo = F}
# examine exclusion
kable(excludedCounts("study 2"), align = "l",
      caption = "Study 2: Exclusion")

# make demographics tables
kable(demoSampleSize("study 2"), align = "l", digits = 2, 
      caption = "Study 2: Sample size")
kable(demoDuration("study 2"), align = "l", digits = 2,
      caption = "Study 2: Study duration (minutes)")
kable(demoAge("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant age (years; approximate)")
kable(demoGender("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant gender")
kable(demoRace("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant race/ethnicity")
kable(demoReligion("study 2"), align = "l", digits = 2,
      caption = "Study 2: Participant religion")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Exploratory factor analysis

### EFA: BEETLE condition

#### Step 1: Determine how many factors to extract

```{r s2 beetle how many factors, echo = F}
howManyFactors(d2_beetle)
```

```{r s2 beetle set nfactors, echo = F}
# set number of factors to extract
nfactors_d2_beetle <- 2
```

#### Step 2: Run EFA without rotation

```{r s2 beetle no rotation, echo = F}
# run EFA without rotation with N factors
efa_d2_beetle_unrotated <- fa(d2_beetle, 15, rotate = "none",
                              cor = "cor", fm = "minres")
print(efa_d2_beetle_unrotated)

# get loadings for each factor
efa_d2_beetle_unrotated_loadings <- getFactorLoadings(efa_d2_beetle_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s2 beetle oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d2_beetle_rotatedN <- fa(d2_beetle, nfactors_d2_beetle, 
                             rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d2_beetle_rotatedN)

# get loadings for each factor
efa_d2_beetle_rotatedN_loadings <- getFactorLoadings(efa_d2_beetle_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s2 beetle oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d2_beetle_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 2, BEETLE condition: Rotated Factor 1")
```

##### Factor 2

```{r s2 beetle oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d2_beetle_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 2, BEETLE condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s2 beetle oblimin rotation F3, echo = F}
# # examine factor 3
# kable(efa_d2_beetle_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 2, BEETLE condition: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

### EFA: ROBOT condition

#### Step 1: Determine how many factors to extract

```{r s2 robot how many factors, echo = F}
howManyFactors(d2_robot)
```

```{r s2 robot set nfactors, echo = F}
# set number of factors to extract
nfactors_d2_robot <- 2
```

#### Step 2: Run EFA without rotation

```{r s2 robot no rotation, echo = F}
# run EFA without rotation with N factors
efa_d2_robot_unrotated <- fa(d2_robot, 15, rotate = "none",
                             cor = "cor", fm = "minres")
print(efa_d2_robot_unrotated)

# get loadings for each factor
efa_d2_robot_unrotated_loadings <- getFactorLoadings(efa_d2_robot_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s2 robot oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d2_robot_rotatedN <- fa(d2_robot, nfactors_d2_robot, 
                            rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d2_robot_rotatedN)

# get loadings for each factor
efa_d2_robot_rotatedN_loadings <- getFactorLoadings(efa_d2_robot_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s2 robot oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d2_robot_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 2, ROBOT condition: Rotated Factor 1")
```

##### Factor 2

```{r s2 robot oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d2_robot_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 2, ROBOT condition: Rotated Factor 2")
```

##### Factor 3 (*not applicable*)

```{r s2 robot oblimin rotation F3, echo = F}
# # examine factor 3
# kable(efa_d2_robot_rotatedN_loadings[[3]], 
#       align = "l", caption = "Study 2, ROBOT condition: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

### EFA: ALL conditions

#### Step 1: Determine how many factors to extract

```{r s2 all how many factors, echo = F}
howManyFactors(d2_all)
```

```{r s2 all set nfactors, echo = F}
# set number of factors to extract
nfactors_d2_all <- 3
```

#### Step 2: Run EFA without rotation

```{r s2 all no rotation, echo = F}
# run EFA without rotation with N factors
efa_d2_all_unrotated <- fa(d2_all, 15, rotate = "none", 
                           cor = "cor", fm = "minres")
print(efa_d2_all_unrotated)

# get loadings for each factor
efa_d2_all_unrotated_loadings <- getFactorLoadings(efa_d2_all_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s2 all oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d2_all_rotatedN <- fa(d2_all, nfactors_d2_all, 
                          rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d2_all_rotatedN)

# get loadings for each factor
efa_d2_all_rotatedN_loadings <- getFactorLoadings(efa_d2_all_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s2 all oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d2_all_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 2, ALL conditions: Rotated Factor 1")
```

##### Factor 2

```{r s2 all oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d2_all_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 2, ALL conditions: Rotated Factor 2")
```

##### Factor 3

```{r s2 all oblimin rotation F3, echo = F}
# examine factor 3
kable(efa_d2_all_rotatedN_loadings[[3]], 
      align = "l", caption = "Study 2, ALL conditions: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Confirmatory factor analysis

### CFA: All conditions

#### ModelDD: Data-driven, three factors (experience, MR2, MR3; see Study 1)

```{r s2 cfa modelDD: 3 factors (data-driven), echo = F}
# test model
d2_all_fitDD <- customCFA(d2_all, modelDD)
summary(d2_all_fitDD, fit.measures = TRUE)
```

#### ModelWDM: Theoretical, three factors (SOCIAL-EMOTIONAL, BIOLOGICAL, PERCEPTUAL; see Weisman et al., 2015)

```{r s2 cfa modelWDM: 3 factors (theory-based), echo = F}
# test model
d2_all_fitWDM <- customCFA(d2_all, modelWDM)
summary(d2_all_fitWDM, fit.measures = TRUE)
```

#### ModelGGW: Theoretical, two factors (AGENCY, EXPERIENCE; see Gray et al., 2007)

```{r s2 cfa modelGGW: 2 factors (theory-based), echo = F}
# test model
d2_all_fitGGW <- customCFA(d2_all, modelGGW)
summary(d2_all_fitGGW, fit.measures = TRUE)
```

#### Compare models (not yet implemented)

```{r s2 cfa model comparison}
# MODELS HAVE DIFFERENT SETS OF VARIABLES, MIGHT NOT WORK
# # compare models (iff continuous and ML)
# customVuong(chosenDD = d2_all_fitDD, 
#             chosenWDM = d2_all_fitWDM, 
#             chosenGGW = d2_all_fitGGW)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Study 3 (2016-01-10, 2 conditions, within-subjects)

## Demographics

```{r s3 demographics, echo = F}
# examine exclusion
kable(excludedCounts("study 3"), align = "l",
      caption = "Study 3: Exclusion")

# make demographics tables
kable(demoSampleSize("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Sample size")
kable(demoDuration("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Study duration (minutes)")
kable(demoAge("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant age (years; approximate)")
kable(demoGender("study 3"), align = "l", digits = 2, 
      caption = "Study 3: Participant gender")
kable(demoRace("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant race/ethnicity")
kable(demoReligion("study 3"), align = "l", digits = 2,
      caption = "Study 3: Participant religion")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Exploratory factor analysis

### EFA: ALL conditions

#### Step 1: Determine how many factors to extract

```{r s3 all how many factors, echo = F}
howManyFactors(d3_all)
```

```{r s3 all set nfactors, echo = F}
# set number of factors to extract
nfactors_d3_all <- 3
```

#### Step 2: Run EFA without rotation

```{r s3 all no rotation, echo = F}
# run EFA without rotation with N factors
efa_d3_all_unrotated <- fa(d3_all, 15, rotate = "none", 
                           cor = "cor", fm = "minres")
print(efa_d3_all_unrotated)

# get loadings for each factor
efa_d3_all_unrotated_loadings <- getFactorLoadings(efa_d3_all_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s3 all oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d3_all_rotatedN <- fa(d3_all, nfactors_d3_all, 
                          rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d3_all_rotatedN)

# get loadings for each factor
efa_d3_all_rotatedN_loadings <- getFactorLoadings(efa_d3_all_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s3 all oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d3_all_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 3, ALL conditions: Rotated Factor 1")
```

##### Factor 2

```{r s3 all oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d3_all_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 3, ALL conditions: Rotated Factor 2")
```

##### Factor 3

```{r s3 all oblimin rotation F3, echo = F}
# examine factor 3
kable(efa_d3_all_rotatedN_loadings[[3]], 
      align = "l", caption = "Study 3, ALL conditions: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Confirmatory factor analysis

### CFA: All conditions

#### ModelDD: Data-driven, three factors (MR1, MR2, MR3; see Study 1)

```{r s3 cfa modelDD: 3 factors (data-driven), echo = F}
# test model
d3_all_fitDD <- customCFA(d3_all, modelDD)
summary(d3_all_fitDD, fit.measures = TRUE)
```

#### ModelWDM: Theoretical, three factors (SOCIAL-EMOTIONAL, BIOLOGICAL, PERCEPTUAL; see Weisman et al., 2015)

```{r s3 cfa modelWDM: 3 factors (theory-based), echo = F}
# test model
d3_all_fitWDM <- customCFA(d3_all, modelWDM)
summary(d3_all_fitWDM, fit.measures = TRUE)
```

#### ModelGGW: Theoretical, two factors (AGENCY, EXPERIENCE; see Gray et al., 2007)

```{r s3 cfa modelGGW: 2 factors (theory-based), echo = F}
# test model
d3_all_fitGGW <- customCFA(d3_all, modelGGW)
summary(d3_all_fitGGW, fit.measures = TRUE)
```

#### Compare models (not yet implemented)

```{r s3 cfa model comparison}
# MODELS HAVE DIFFERENT SETS OF VARIABLES, MIGHT NOT WORK
# # compare models (iff continuous and ML)
# customVuong(chosenDD = d3_all_fitDD, 
#             chosenWDM = d3_all_fitWDM, 
#             chosenGGW = d3_all_fitGGW)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

# Study 4 (2016-01-14, 21 conditions, between-subjects)

## Demographics

```{r s4 demographics, echo = F}
# examine exclusion
kable(excludedCounts("study 4"), align = "l",
      caption = "Study 4: Exclusion")

# make demographics tables
kable(demoSampleSize("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Sample size")
kable(demoDuration("study 4"), align = "l", digits = 2,
      caption = "Study 4: Study duration (minutes)")
kable(demoAge("study 4"), align = "l", digits = 2,
      caption = "Study 4: Participant age (years; approximate)")
kable(demoGender("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Participant gender")
kable(demoRace("study 4"), align = "l", digits = 2,
      caption = "Study 4: Participant race/ethnicity")
kable(demoEducation("study 4"), align = "l", digits = 2, 
      caption = "Study 4: Participant education")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Exploratory factor analysis

### EFA: ALL conditions

#### Step 1: Determine how many factors to extract

```{r s4 all how many factors, echo = F}
howManyFactors(d4_all)
```

```{r s4 all set nfactors, echo = F}
# set number of factors to extract
nfactors_d4_all <- 3
```

#### Step 2: Run EFA without rotation

```{r s4 all no rotation, echo = F}
# run EFA without rotation with N factors
efa_d4_all_unrotated <- fa(d4_all, 15, rotate = "none", 
                           cor = "cor", fm = "minres")
print(efa_d4_all_unrotated)

# get loadings for each factor
efa_d4_all_unrotated_loadings <- getFactorLoadings(efa_d4_all_unrotated)
```

#### Step 3: Run EFA with oblimin rotation

```{r s4 all oblimin rotation, echo = F}
# run EFA with rotation with N factors
efa_d4_all_rotatedN <- fa(d4_all, nfactors_d4_all, 
                          rotate = "oblimin", cor = "cor", fm = "minres")
print(efa_d4_all_rotatedN)

# get loadings for each factor
efa_d4_all_rotatedN_loadings <- getFactorLoadings(efa_d4_all_rotatedN)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

##### Factor 1

```{r s4 all oblimin rotation F1, echo = F}
# examine factor 1
kable(efa_d4_all_rotatedN_loadings[[1]], 
      align = "l", caption = "Study 4, ALL conditions: Rotated Factor 1")
```

##### Factor 2

```{r s4 all oblimin rotation F2, echo = F}
# examine factor 2
kable(efa_d4_all_rotatedN_loadings[[2]], 
      align = "l", caption = "Study 4, ALL conditions: Rotated Factor 2")
```

##### Factor 3

```{r s4 all oblimin rotation F3, echo = F}
# examine factor 3
kable(efa_d4_all_rotatedN_loadings[[3]], 
      align = "l", caption = "Study 4, ALL conditions: Rotated Factor 3")
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>

## Confirmatory factor analysis

### CFA: ALL conditions

#### ModelDD: Data-driven, three factors (MR1, MR2, MR3; see Study 1)

```{r s4 cfa modelDD: 3 factors (data-driven), echo = F}
# test model
d4_all_fitDD <- customCFA(d4_all, modelDD)
summary(d4_all_fitDD, fit.measures = TRUE)
```

```{r s4 cfa modelDD factor scores, echo = F}
# use best model to get factor scores by participant
d4_all_fitDD_predict <- predict(d4_all_fitDD)

# use dummy model to get subid into factor scores
modelDD_dummy <- gsub("=~", "~~", modelDD)
modelDD_dummy <- gsub("MR1", "subid", modelDD_dummy)
modelDD_dummy <- gsub("MR2", "subid", modelDD_dummy)
modelDD_dummy <- gsub("MR3", "subid", modelDD_dummy)
dummy_fitDD <- cfa(modelDD_dummy, d4 %>%
                   select(subid, happy:pride), ordered = FALSE, estimator = chosenEstimator)

dummy_dataDD <- dummy_fitDD@Data@X[[1]]
d4_all_fitDD_predict <- data.frame(d4_all_fitDD_predict,
                                   subid = dummy_dataDD[,1])

d4_subids <- d4 %>% select(subid, condition) %>%
  mutate(subid_num = as.numeric(subid)) %>%
  rename(subid_cat = subid,
         subid = subid_num)

d4_factor_scoresDD <- d4_all_fitDD_predict %>%
  full_join(d4_subids, by = "subid")

# remove extraneous variables
rm(d4_all_fitDD_predict, modelDD_dummy, dummy_fitDD, dummy_dataDD, d4_subids)
```

```{r s4 cfa modelDD average factor scores by condition, echo = F}
d4_factor_scoresDD_condition <- d4_factor_scoresDD %>%
  group_by(condition) %>%
  summarise(MR1_mean = mean(MR1),
            MR1_sd = sd(MR1),
            MR1_n = length(MR1),
            MR2_mean = mean(MR2),
            MR2_sd = sd(MR2),
            MR2_n = length(MR2),
            MR3_mean = mean(MR3),
            MR3_sd = sd(MR3),
            MR3_n = length(MR3))

# d4_factor_scoresDD_condition_mb <- d4_factor_scoresDD %>%
#   gather(factor, score, c(MR1, MR2, MR3)) %>%
#   multi_boot(column = "score",
#              summary_groups = c("condition", "factor"),
#              statistics_functions = c("ci_lower", "mean", "ci_upper"))
```

```{r s4 cfa modelDD plot: MR1 vs. MR2, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = MR1_mean, y = MR2_mean, colour = condition), 
       data = d4_factor_scoresDD_condition) +
  geom_errorbar(aes(ymin = MR2_mean - MR2_sd/sqrt(MR2_n),
                    ymax = MR2_mean + MR2_sd/sqrt(MR2_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = MR1_mean - MR1_sd/sqrt(MR1_n),
                     xmax = MR1_mean + MR1_sd/sqrt(MR1_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, MR1 vs. MR2\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: MR1",
       y = "Average score: MR2\n")
```

```{r s4 cfa modelDD plot: MR1 vs. MR3, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = MR1_mean, y = MR3_mean, colour = condition), 
       data = d4_factor_scoresDD_condition) +
  geom_errorbar(aes(ymin = MR3_mean - MR3_sd/sqrt(MR3_n),
                    ymax = MR3_mean + MR3_sd/sqrt(MR3_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = MR1_mean - MR1_sd/sqrt(MR1_n),
                     xmax = MR1_mean + MR1_sd/sqrt(MR1_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, MR1 vs. MR3\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: MR1",
       y = "Average score: MR3\n")
```

```{r s4 cfa modelDD plot: MR2 vs. MR3, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = MR2_mean, y = MR3_mean, colour = condition), 
       data = d4_factor_scoresDD_condition) +
  geom_errorbar(aes(ymin = MR3_mean - MR3_sd/sqrt(MR3_n),
                    ymax = MR3_mean + MR3_sd/sqrt(MR3_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = MR2_mean - MR2_sd/sqrt(MR2_n),
                     xmax = MR2_mean + MR2_sd/sqrt(MR2_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, MR2 vs. MR3\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: MR2",
       y = "Average score: MR3\n")
```

#### ModelWDM: Theoretical, three factors (SOCIAL-EMOTIONAL, BIOLOGICAL, PERCEPTUAL; see Weisman et al., 2015)

```{r s4 cfa modelWDM: 3 factors (theory-driven), echo = F}
# test model
d4_all_fitWDM <- customCFA(d4_all, modelWDM)
summary(d4_all_fitWDM, fit.measures = TRUE)
```

```{r s4 cfa modelWDM factor scores, echo = F}
# use best model to get factor scores by participant
d4_all_fitWDM_predict <- predict(d4_all_fitWDM)

# use dummy model to get subid into factor scores
modelWDM_dummy <- gsub("=~", "~~", modelWDM)
modelWDM_dummy <- gsub("soc_emo", "subid", modelWDM_dummy)
modelWDM_dummy <- gsub("biological", "subid", modelWDM_dummy)
modelWDM_dummy <- gsub("perceptual", "subid", modelWDM_dummy)
dummy_fitWDM <- cfa(modelWDM_dummy, d4 %>%
                   select(subid, happy:pride), ordered = FALSE, estimator = chosenEstimator)

dummy_dataWDM <- dummy_fitWDM@Data@X[[1]]
d4_all_fitWDM_predict <- data.frame(d4_all_fitWDM_predict,
                                   subid = dummy_dataWDM[,1])

d4_subids <- d4 %>% select(subid, condition) %>%
  mutate(subid_num = as.numeric(subid)) %>%
  rename(subid_cat = subid,
         subid = subid_num)

d4_factor_scoresWDM <- d4_all_fitWDM_predict %>%
  full_join(d4_subids, by = "subid")

# remove extraneous variables
rm(d4_all_fitWDM_predict, modelWDM_dummy, dummy_fitWDM, dummy_dataWDM, d4_subids)
```

```{r s4 cfa modelWDM average factor scores by condition, echo = F}
d4_factor_scoresWDM_condition <- d4_factor_scoresWDM %>%
  group_by(condition) %>%
  summarise(soc_emo_mean = mean(soc_emo),
            soc_emo_sd = sd(soc_emo),
            soc_emo_n = length(soc_emo),
            biological_mean = mean(biological),
            biological_sd = sd(biological),
            biological_n = length(biological),
            perceptual_mean = mean(perceptual),
            perceptual_sd = sd(perceptual),
            perceptual_n = length(perceptual))

# d4_factor_scoresWDM_condition_mb <- d4_factor_scoresWDM %>%
#   gather(factor, score, c(soc_emo, biological, perceptual)) %>%
#   multi_boot(column = "score",
#              summary_groups = c("condition", "factor"),
#              statistics_functions = c("ci_lower", "mean", "ci_upper"))
```

```{r s4 cfa modelWDM plot: soc_emo vs. biological, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = soc_emo_mean, y = biological_mean, colour = condition), 
       data = d4_factor_scoresWDM_condition) +
  geom_errorbar(aes(ymin = biological_mean - biological_sd/sqrt(biological_n),
                    ymax = biological_mean + biological_sd/sqrt(biological_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = soc_emo_mean - soc_emo_sd/sqrt(soc_emo_n),
                     xmax = soc_emo_mean + soc_emo_sd/sqrt(soc_emo_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, SOCIAL-EMOTIONAL vs. BIOLOGICAL\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: SOCIAL-EMOTIONAL",
       y = "Average score: BIOLOGICAL\n")
```

```{r s4 cfa modelWDM plot: soc_emo vs. perceptual, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = soc_emo_mean, y = perceptual_mean, colour = condition), 
       data = d4_factor_scoresWDM_condition) +
  geom_errorbar(aes(ymin = perceptual_mean - perceptual_sd/sqrt(perceptual_n),
                    ymax = perceptual_mean + perceptual_sd/sqrt(perceptual_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = soc_emo_mean - soc_emo_sd/sqrt(soc_emo_n),
                     xmax = soc_emo_mean + soc_emo_sd/sqrt(soc_emo_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, SOCIAL-EMOTIONAL vs. PERCEPTUAL\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: SOCIAL-EMOTIONAL",
       y = "Average score: PERCEPTUAL\n")
```

```{r s4 cfa modelWDM plot: biological vs. perceptual, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = biological_mean, y = perceptual_mean, colour = condition), 
       data = d4_factor_scoresWDM_condition) +
  geom_errorbar(aes(ymin = perceptual_mean - perceptual_sd/sqrt(perceptual_n),
                    ymax = perceptual_mean + perceptual_sd/sqrt(perceptual_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = biological_mean - biological_sd/sqrt(biological_n),
                     xmax = biological_mean + biological_sd/sqrt(biological_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Data-driven model, BIOLOGICAL vs. PERCEPTUAL\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: BIOLOGICAL",
       y = "Average score: PERCEPTUAL\n")
```

#### ModelGGW: Theoretical, two factors (AGENCY, EXPERIENCE; see Gray et al., 2007)

```{r s4 cfa modelGGW: 2 factors (theory-based), echo = F}
# test model
d4_all_fitGGW <- customCFA(d4_all, modelGGW)
summary(d4_all_fitGGW, fit.measures = TRUE)
```

```{r s4 cfa modelGGW factor scores, echo = F}
# use best model to get factor scores by participant
d4_all_fitGGW_predict <- predict(d4_all_fitGGW)

# use dummy model to get subid into factor scores
modelGGW_dummy <- gsub("=~", "~~", modelGGW)
modelGGW_dummy <- gsub("experience", "subid", modelGGW_dummy)
modelGGW_dummy <- gsub("agency", "subid", modelGGW_dummy)
dummy_fitGGW <- cfa(modelGGW_dummy, d4 %>%
                   select(subid, happy:pride), ordered = FALSE, estimator = chosenEstimator)

dummy_dataGGW <- dummy_fitGGW@Data@X[[1]]
d4_all_fitGGW_predict <- data.frame(d4_all_fitGGW_predict,
                                   subid = dummy_dataGGW[,1])

d4_subids <- d4 %>% select(subid, condition) %>%
  mutate(subid_num = as.numeric(subid)) %>%
  rename(subid_cat = subid,
         subid = subid_num)

d4_factor_scoresGGW <- d4_all_fitGGW_predict %>%
  full_join(d4_subids, by = "subid")

# remove extraneous variables
rm(d4_all_fitGGW_predict, modelGGW_dummy, dummy_fitGGW, dummy_dataGGW, d4_subids)
```

```{r s4 cfa modelGGW average factor scores by condition, echo = F}
d4_factor_scoresGGW_condition <- d4_factor_scoresGGW %>%
  group_by(condition) %>%
  summarise(experience_mean = mean(experience),
            experience_sd = sd(experience),
            experience_n = length(experience),
            agency_mean = mean(agency),
            agency_sd = sd(agency),
            agency_n = length(agency))

# d4_factor_scoresGGW_condition_mb <- d4_factor_scoresGGW %>%
#   gather(factor, score, c(MR1, MR2)) %>%
#   multi_boot(column = "score",
#              summary_groups = c("condition", "factor"),
#              statistics_functions = c("ci_lower", "mean", "ci_upper"))
```

```{r s4 cfa modelGGW plot: experience vs. agency, echo = F, fig.height = 8, fig.width = 8}
ggplot(aes(x = experience_mean, y = agency_mean, colour = condition), 
       data = d4_factor_scoresGGW_condition) +
  geom_errorbar(aes(ymin = agency_mean - agency_sd/sqrt(agency_n),
                    ymax = agency_mean + agency_sd/sqrt(agency_n)),
                width = 0.1, alpha = 0.4) +
  geom_errorbarh(aes(xmin = experience_mean - experience_sd/sqrt(experience_n),
                     xmax = experience_mean + experience_sd/sqrt(experience_n)),
                 height = 0.1, alpha = 0.4) +
  geom_point(size = 4) +
  geom_dl(aes(label = condition), method = "smart.grid") +
  theme_bw() +
  scale_color_manual(values = tol21rainbow) +
  theme(text = element_text(size = 20),
        legend.position = "none") +
  scale_x_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  scale_y_continuous(limits = c(-3.6, 3.6), breaks = seq(-3, 3, 0.5)) +
  labs(title = "Study 4: Theoretical model (GGW2007), EXPERIENCE vs. AGENCY\n(Error bars are 95% CIs)\n",
       x = "\nAverage score: EXPERIENCE",
       y = "Average score: AGENCY\n")
```

#### Compare models (not yet implemented)

```{r s4 cfa model comparison}
# MODELS HAVE DIFFERENT SETS OF VARIABLES, MIGHT NOT WORK
# # compare models (iff continuous and ML)
# customVuong(chosenDD = d4_all_fitDD, 
#             chosenWDM = d4_all_fitWDM, 
#             chosenGGW = d4_all_fitGGW)
```

<p style="text-align:right"><a href="#header">back to TOC</a></p>
